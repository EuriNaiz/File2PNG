Сохранение произвольных файлов как PNG
======================================

PNG это формат изображения со сжатием без потерь. Значит можно произвольный файл, не обязательно изображение, прочитать как raw изображение и сконвертировать в PNG, затем без потерь сконвертировать обратно.

Для конвертации будет использоваться утилита `convert` из состава ImageMagick.

На вход будем подавать изображения в формате rgb. Опытным путём выяснено что один пиксель там занимает 3 байта. Значит делим размер исходного файла на 3, получаем количество пикселей. Нам нужно получить разрешение изображения.

Вычисляем корень из количества пикселей. Если получилось не целое число, то округляем в большую сторону и возводим в степень двойки. Или так. У нас допустим получилось 143,1632. Тогда можно использовать разрешение 143x144 или 144x144. Умножаем ширину на высоту, полученное число пикселей снова умножаем на 3 (число байт на пиксель), у нас получится число байт, которое должно быть в rgb файле.

Можно во входящем файле сохранить размер исходного файла, чтобы его можно было точно восстановить. Можно даже и хеш исходного файла.

    cp input.file prepared.file
    echo '' >> prepared.file
    echo "### SIZE: $(stat -c '%s' input.file) ###" >> prepared.file
    echo "### SHA256: $(sha256 -b input.file | awk '{print $1}') ###" >> prepared.file

Смотрим размер полученного файла `prepared.file`, доводим его до нужного размера, дописав из /dev/zero недостающие байты с помощью `dd bs= count=1`. Размер файла должен быть `X*Y*3` байт. Это необходимо, иначе утилита `convert` будет ругаться и на выходе мы получим битый файл.

Ковертируем в PNG:

    convert -size 143x144 -depth 8 rgb:prepared.file out.png

Ковертируем обратно:

    convert out.png rgb:out.rgb

Восстанавливаем как-то так:

    origsize="$(strings out.rgb | grep '### SIZE:' | awk '{print $3 }')"
    origsha="$(strings out.rgb | grep '### SHA256:' | awk '{print $3 }')"
    dd if=out.rgb of=unpacked.file bs=$origsize count=1
    echo "Original SHA256: $origsha"
    echo "Output sha256: $(sha256sum -b "$unpacked.file")"
